name: Auto release mods zip

on:
  push:
    branches:
      - main                # dispara al push en main
    tags:
      - 'v*'                # dispara al push de tags que empiecen con v
  create:
    tags:
      - '*'                 # también captura cuando se crea un tag (evento create)

permissions:
  contents: write          # necesario para crear releases y subir assets

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set variables (date, short sha, tag detection)
        id: vars
        run: |
          # fecha en UTC YYYYMMDD
          DATE=$(date -u +%Y%m%d)
          # short SHA
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          # Detectar si el evento es un tag (refs/tags/<tagname>)
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            IS_TAG="true"
          else
            # si no hay tag, creamos uno identificador automático
            TAG="auto-${SHORT_SHA}"
            IS_TAG="false"
          fi

          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "is_tag=${IS_TAG}" >> $GITHUB_OUTPUT

      - name: Create zip (mods folder)
        run: |
          ZIP_NAME="mods-${{ steps.vars.outputs.date }}-v${{ steps.vars.outputs.tag }}.zip"
          echo "Creating $ZIP_NAME"
          # Ajusta la ruta 'mods' si tu carpeta tiene otro nombre
          zip -r "$ZIP_NAME" mods
          ls -lh "$ZIP_NAME"
        shell: bash

      - name: Create or get Release
        id: create_release
        uses: actions/create-release@v1
        with:
          # Si el tag ya venía (creado por el usuario), lo usamos; si no, usamos el tag auto generado.
          tag_name: ${{ steps.vars.outputs.tag }}
          release_name: "mods - ${{ steps.vars.outputs.date }} - v${{ steps.vars.outputs.tag }}"
          body: "Release automática generada por workflow — zip: mods-${{ steps.vars.outputs.date }}-v${{ steps.vars.outputs.tag }}.zip"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset (zip)
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./mods-${{ steps.vars.outputs.date }}-v${{ steps.vars.outputs.tag }}.zip
          asset_name: mods-${{ steps.vars.outputs.date }}-v${{ steps.vars.outputs.tag }}.zip
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print download URL
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          DATE="${{ steps.vars.outputs.date }}"
          USER="$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)"
          REPO="$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)"
          echo "URL de descarga (asset):"
          echo "https://github.com/$USER/$REPO/releases/download/$TAG/mods-$DATE-v$TAG.zip"
